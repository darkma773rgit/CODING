{% extends "base.html" %}

{% block title %}Edit API Connection - Finance Dashboard{% endblock %}
{% block page_title %}Edit API Connection{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit"></i> Edit API Connection
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="editApiConnectionForm">
                    <div class="mb-3">
                        <label for="institution_name" class="form-label">
                            <i class="fas fa-building"></i> Institution Name
                        </label>
                        <input type="text" class="form-control" id="institution_name" name="institution_name" 
                               value="{{ connection.institution_name }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="api_type" class="form-label">
                            <i class="fas fa-list"></i> Service Type
                        </label>
                        <select class="form-select" id="api_type" name="api_type" required onchange="toggleCredentials()">
                            <option value="">Select service type...</option>
                            <option value="plaid" {{ 'selected' if connection.api_type == 'plaid' else '' }}>Bank Accounts (Plaid)</option>
                            <option value="yfinance" {{ 'selected' if connection.api_type == 'yfinance' else '' }}>Investment Data (Yahoo Finance)</option>
                        </select>
                    </div>

                    <!-- Plaid Credentials -->
                    <div id="plaid-credentials" style="display: {{ 'block' if connection.api_type == 'plaid' else 'none' }};">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Plaid Setup Required:</strong> You'll need to create a Plaid account and get API credentials.
                            <a href="https://plaid.com/developers/" target="_blank" class="alert-link">Get Plaid API Keys</a>
                        </div>
                        
                        <div class="mb-3">
                            <label for="plaid_client_id" class="form-label">
                                <i class="fas fa-key"></i> Plaid Client ID
                            </label>
                            <input type="text" class="form-control" id="plaid_client_id" name="plaid_client_id" 
                                   value="{{ connection.credentials.get('client_id', '') }}"
                                   placeholder="Your Plaid client ID">
                        </div>
                        
                        <div class="mb-3">
                            <label for="plaid_secret" class="form-label">
                                <i class="fas fa-lock"></i> Plaid Secret
                            </label>
                            <input type="password" class="form-control" id="plaid_secret" name="plaid_secret" 
                                   value="{{ connection.credentials.get('secret', '') }}"
                                   placeholder="Your Plaid secret key">
                        </div>
                        
                        <div class="mb-3">
                            <label for="plaid_access_token" class="form-label">
                                <i class="fas fa-link"></i> Access Token
                            </label>
                            <input type="text" class="form-control" id="plaid_access_token" name="plaid_access_token" 
                                   value="{{ connection.credentials.get('access_token', '') }}"
                                   placeholder="Your access token">
                            <div class="form-text">Get this by linking your bank account through Plaid's Link flow.</div>
                        </div>
                    </div>

                    <!-- YFinance Info -->
                    <div id="yfinance-info" style="display: {{ 'block' if connection.api_type == 'yfinance' else 'none' }};">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>No Setup Required:</strong> Yahoo Finance API is free and doesn't require credentials.
                            Just add your stock symbols and crypto holdings to get real-time data.
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('api_connections') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Connection
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title text-success">
                    <i class="fas fa-shield-alt"></i> Security Notice
                </h6>
                <p class="card-text small text-muted">
                    All sensitive information is encrypted and stored locally on your device. 
                    Your data never leaves your computer and is protected with industry-standard encryption.
                    Updating credentials will re-encrypt and store the new information securely.
                </p>
            </div>
        </div>

        <!-- Current Connection Info -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Current Connection Information
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Institution:</strong></td>
                        <td>{{ connection.institution_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Service Type:</strong></td>
                        <td class="text-capitalize">{{ connection.api_type }}</td>
                    </tr>
                    <tr>
                        <td><strong>Connection ID:</strong></td>
                        <td><code>{{ connection.id }}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleCredentials() {
    const apiType = document.getElementById('api_type').value;
    const plaidDiv = document.getElementById('plaid-credentials');
    const yfinanceDiv = document.getElementById('yfinance-info');
    
    // Hide all credential sections
    plaidDiv.style.display = 'none';
    yfinanceDiv.style.display = 'none';
    
    // Show relevant section
    if (apiType === 'plaid') {
        plaidDiv.style.display = 'block';
    } else if (apiType === 'yfinance') {
        yfinanceDiv.style.display = 'block';
    }
}

// Initialize the form based on current API type
document.addEventListener('DOMContentLoaded', function() {
    toggleCredentials();
});
</script>
{% endblock %}
